AssetBundleビルド戦略
【1. AssetBundle を使用する理由】

Unity では実行時リソース読み込みに「Resources フォルダ」と「AssetBundle」の 2 種類の方法があります。

Resources フォルダ
　アプリビルド時に全てのリソースがパッケージに含まれるため、容量増大や更新の柔軟性に欠けます。

AssetBundle
　パッケージ外から読み込みが可能で、圧縮およびホットアップデートに対応。
　つまり、インストールサイズの削減と動的リソース管理が実現できます。

【2. AssetBundle の圧縮方式】
圧縮方式	特徴
None	圧縮なし。ビルドは速いが容量が大きくなる。
LZMA	最も圧縮率が高いが、展開に時間がかかり、展開後サイズも大きい。
LZ4	LZMA より圧縮率は低いが、読み込み・展開が高速です。

通常は LZ4 を使用し、Unity では BuildAssetBundleOptions.ChunkBasedCompression により設定します。


【3、AssetBundle のビルド戦略】

AssetBundle（以下「ABパック」）は、サイズを大きくしすぎないことが重要です。
必要に応じて細かく分割し、リソースのダウンロード効率や更新管理を最適化します。

共通リソースはカテゴリごとに分けて配置し、初回パッケージまたは初回ダウンロード時に取得できるようにします。

🧩 構成ファイル（JSON）の作成

まず、ビルド時に以下の情報をまとめた JSON ファイルを生成します。

除外フォルダパス
　→ AssetBundle に含めないフォルダのパス。これらはビルド対象外になります。

メインリソースパス
　→ 実際にロード対象となる主要リソースのパス（例：Prefab など）。

依存リソースパス
　→ メインリソースが参照している依存ファイルのパス。

📦 パッケージ分けのルール

メインリソースと依存リソースをもとに、
どのフォルダを「ファイル単位」でAssetBundle化するか、または「フォルダ単位」でまとめてAssetBundle化するかを決定します。

ファイル拡張子やリソースの種類に応じて、適切なAssetBundle単位を設定します。

🚀 ダウンロード設計

ランチャー用リソースと後続のホットアップデートリソースを明確に分けます。

ホットアップデート対象のリソースはさらに細分化します、
　UI 画面ごとに 1 つの AssetBundle に分けてビルドします。

初期状態では一部のステージのみをダウンロードし、
　プレイヤーが特定ステージにアクセスした際に、そのステージに必要なリソースを追加で取得します。

このようにすることで、ユーザーが実際に必要とする機能やコンテンツのみをダウンロードする構造となり、
端末のストレージ使用量を大幅に削減できます。

【4. 重複ビルドを防ぐ方法】

メインリソースパス内のアセットをビルドする際、依存関係を解析して GUID を収集し、
GUID をハッシュテーブルに登録して処理済みリソースを管理します。

また、各アセットに設定された AssetBundle 名を別のハッシュテーブルに記録し、
すでに同一名の AssetBundle が存在するかをチェックします。

依存パスを走査する際はこの 2 種のハッシュテーブルを参照し、
GUID または AssetBundle 名の重複を検出した場合はスキップして重複ビルドを回避します。

【5. ビルド後のマニフェスト生成（ホットアップデート用）】

AssetBundle ビルド完了後、メインマニフェストから全 AssetBundle の情報を取得し、
以下の内容を記録した リソースマニフェストファイル を生成します。

現在のリソースバージョン
各 AssetBundle 名
ファイルパス
MD5 ハッシュ値
ファイルサイズ
ホットアップデート時は、サーバ上のマニフェストとローカルマニフェストを比較し、更新が必要なリソースのみをダウンロード します。
【6. AssetBundle の循環参照（ループ依存）対策】
■ 問題概要

AssetBundle 同士が相互に依存している場合、循環参照（Circular Reference） が発生します。
これにより、ロード順序が不明確になり、依存関係解決のために無駄な読み込み・メモリ消費が発生する可能性があります。
最悪の場合、ロードがデッドロック状態となり、実行時エラーが発生します。

■ 対策方針

直接的な循環依存の回避 
　AssetBundle を設計する段階で、2 つ以上の AssetBundle が互い に依存し合う構造を避ける ようにします。
　リソース構成を見直し、共通アセットは専用の「共通AssetBundle」にまとめるなど、依存を明確化します。

Prefab のネスト構造を簡略化
　Prefab の入れ子構造が深いほど依存関係が複雑化します。
　可能な限りネストを浅くし、UI やオブジェクト間の参照を分離します。

単方向依存の維持
　AssetBundle の依存関係は 単方向（One-way Dependency） になるよう設計します。
　A → B の依存は許可しても、B → A の依存は避けるようにします。

ロード順序の制御による回避（最終手段）
　依存される側の AB を先にロードし、依存する側は後からロードするように手動管理します。